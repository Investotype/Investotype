// twenty questions with five-answer scales mapped to four dimensions
// each question object contains a dimension and options scored 1-5
const questions = [
  { dimension: 'risk', text: 'How do you feel about stock volatility?', options: ['Very uneasy', 'Somewhat uneasy', 'Neutral', 'Somewhat comfortable', 'Very comfortable'] },
  { dimension: 'risk', text: 'Would you invest in a high-yield but unstable fund?', options: ['Never', 'Unlikely', 'Maybe', 'Likely', 'Absolutely'] },
  { dimension: 'risk', text: 'Is preserving capital more important than growing it?', options: ['Always', 'Usually', 'Sometimes', 'Rarely', 'Never'] },
  { dimension: 'risk', text: 'Would you sleep at night if market dropped 20%?', options: ['No', 'Probably not', 'Unsure', 'Probably yes', 'Yes'] },
  { dimension: 'risk', text: 'Do you prefer guaranteed returns or potential big gains?', options: ['Guaranteed', 'Mostly guaranteed', 'Balanced', 'Mostly big gains', 'Big gains'] },

  { dimension: 'growth', text: 'Are you focused on long-term wealth accumulation?', options: ['Not at all', 'A little', 'Somewhat', 'Mostly', 'Absolutely'] },
  { dimension: 'growth', text: 'Do you reinvest dividends rather than spend them?', options: ['Never', 'Rarely', 'Sometimes', 'Often', 'Always'] },
  { dimension: 'growth', text: 'Would you choose a young startup over a blue-chip firm?', options: ['Never', 'Unlikely', 'Maybe', 'Likely', 'Definitely'] },
  { dimension: 'growth', text: 'Is beating the market your primary goal?', options: ['No', 'Occasionally', 'Sometimes', 'Often', 'Yes'] },
  { dimension: 'growth', text: 'Do you tolerate short-term losses for long-run gains?', options: ['No', 'Rarely', 'Sometimes', 'Usually', 'Yes'] },

  { dimension: 'control', text: 'Do you personally research every investment?', options: ['Never', 'Rarely', 'Sometimes', 'Often', 'Always'] },
  { dimension: 'control', text: 'Would you hire a financial advisor to manage your portfolio?', options: ['Definitely', 'Probably', 'Maybe', 'Probably not', 'No'] },
  { dimension: 'control', text: 'Do you prefer to make all decisions yourself?', options: ['Always', 'Usually', 'Sometimes', 'Rarely', 'Never'] },
  { dimension: 'control', text: 'How comfortable are you delegating investment choices?', options: ['Very uncomfortable', 'Somewhat uncomfortable', 'Neutral', 'Somewhat comfortable', 'Very comfortable'] },
  { dimension: 'control', text: 'Do you follow analyst recommendations closely?', options: ['Never', 'Rarely', 'Sometimes', 'Often', 'Always'] },

  { dimension: 'analysis', text: 'Do you use technical charts when picking stocks?', options: ['Never', 'Rarely', 'Sometimes', 'Often', 'Always'] },
  { dimension: 'analysis', text: 'Do you trust your gut over data?', options: ['Always', 'Often', 'Sometimes', 'Rarely', 'Never'] },
  { dimension: 'analysis', text: 'Are market trends more valuable than company fundamentals?', options: ['Absolutely', 'Mostly', 'Sometimes', 'Rarely', 'Never'] },
  { dimension: 'analysis', text: 'Do you track economic indicators regularly?', options: ['Never', 'Rarely', 'Sometimes', 'Often', 'Always'] },
  { dimension: 'analysis', text: 'Would you buy a stock solely on news buzz?', options: ['Definitely', 'Probably', 'Maybe', 'Probably not', 'No'] }
];

let currentQuestion = 0;
const answers = [];
let shuffledQuestions = [];

function shuffleQuestions(list) {
  const copy = [...list];
  for (let i = copy.length - 1; i > 0; i -= 1) {
    const j = Math.floor(Math.random() * (i + 1));
    const tmp = copy[i];
    copy[i] = copy[j];
    copy[j] = tmp;
  }
  return copy;
}

function showQuestion(index) {
  const container = document.getElementById('question-container');
  if (!container) return;

  const q = shuffledQuestions[index];
  const pct = Math.round((index / questions.length) * 100);

  const progressBar = document.getElementById('progress');
  if (progressBar) progressBar.style.width = pct + '%';

  const counter = document.getElementById('question-counter');
  if (counter) counter.textContent = `Question ${index + 1} of ${questions.length}`;

  container.innerHTML = '';
  const p = document.createElement('p');
  p.textContent = q.text;
  container.appendChild(p);

  q.options.forEach((optText, i) => {
    const div = document.createElement('div');
    div.className = 'option-label';
    div.textContent = optText;
    div.addEventListener('click', () => {
      answers[index] = { dimension: q.dimension, score: i + 1 };
      if (currentQuestion < questions.length - 1) {
        currentQuestion += 1;
        showQuestion(currentQuestion);
      } else {
        showResult();
      }
    });
    container.appendChild(div);
  });

  const prev = document.getElementById('prev-btn');
  if (prev) prev.style.display = index > 0 ? 'inline-block' : 'none';
}

function setupPrevButton() {
  const prevBtn = document.getElementById('prev-btn');
  if (!prevBtn) return;
  prevBtn.addEventListener('click', () => {
    if (currentQuestion > 0) {
      currentQuestion -= 1;
      showQuestion(currentQuestion);
    }
  });
}

function startQuiz() {
  setupPrevButton();
  shuffledQuestions = shuffleQuestions(questions);
  showQuestion(0);
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', startQuiz);
} else {
  startQuiz();
}

function showResult() {
  const progress = document.getElementById('progress');
  const container = document.getElementById('question-container');
  const resultDiv = document.getElementById('result');
  const prevBtn = document.getElementById('prev-btn');
  if (progress) progress.style.width = '100%';
  if (container) container.style.display = 'none';
  if (prevBtn) prevBtn.style.display = 'none';
  if (!resultDiv) return;
  resultDiv.style.display = 'block';

  const totals = { risk: 0, growth: 0, control: 0, analysis: 0 };
  const counts = { risk: 0, growth: 0, control: 0, analysis: 0 };
  answers.forEach((a) => {
    if (!a) return;
    totals[a.dimension] += a.score;
    counts[a.dimension] += 1;
  });

  const avg = {};
  Object.keys(totals).forEach((d) => {
    avg[d] = counts[d] ? totals[d] / counts[d] : 3;
  });

  function letter(dim, lowLetter, highLetter) {
    if (avg[dim] <= 2) return lowLetter;
    if (avg[dim] >= 4) return highLetter;
    return lowLetter;
  }

  const riskBand = avg.risk <= 2 ? 'low' : avg.risk >= 4 ? 'high' : 'mid';
  const growthBand = avg.growth <= 2 ? 'low' : avg.growth >= 4 ? 'high' : 'mid';
  const combo = `${riskBand}-${growthBand}`;

  const typeLookup = {
    'low-low': {
      emoji: 'CP',
      name: 'Capital Preserver',
      desc: 'You are patient, defensive, and highly focused on protecting principal. You are comfortable sacrificing some upside if it materially lowers drawdowns and improves long-term consistency.',
      advice: 'Build around Treasuries, investment-grade bonds, and a smaller sleeve of defensive equities. Favor durable cash-flow businesses such as Johnson & Johnson, Procter & Gamble, and Coca-Cola, which historically hold up better in uncertain cycles.',
      examples: 'Popular investors with similar mindset: Warren Buffett (defensive periods), Howard Marks, and Bill Gates portfolio style through large, durable businesses and conservative position sizing.',
      strengths: 'Your biggest advantage is drawdown resilience. You typically preserve capital better in risk-off periods, maintain emotional control during volatility spikes, and stay invested long enough for compounding to work.',
      weaknesses: 'Your main risk is underexposure to long-run growth. If you stay too defensive during prolonged bull cycles, inflation and opportunity cost can erode real returns.'
    },
    'low-mid': {
      emoji: 'ID',
      name: 'Income Defender',
      desc: 'You prioritize reliable cash flow and controlled volatility. You accept moderate equity risk when business fundamentals are stable and payout quality is strong.',
      advice: 'Emphasize dividend ETFs, utilities, and high-quality REIT exposure, with bond support for downside control. Stock examples include PepsiCo, NextEra Energy, and Realty Income for durable income and lower earnings volatility.',
      examples: 'Popular investors with similar mindset: Bill Gross (income focus), Warren Buffett income holdings, and dividend-growth managers like Jeremy Siegel.',
      strengths: 'You are strong at building sustainable portfolio income and avoiding fragile balance-sheet risk. Your structure is usually easier to hold through moderate drawdowns.',
      weaknesses: 'Income chasing can become a trap if you overpay for yield. You may also lag in innovation-led cycles if growth allocation remains too low.'
    },
    'low-high': {
      emoji: 'BB',
      name: 'Balanced Builder',
      desc: 'You want long-term growth without abandoning risk discipline. You prefer portfolios that can advance in good markets while staying resilient in rough regimes.',
      advice: 'Use a balanced core of global index ETFs and bonds, then add selective quality growth. Microsoft, Apple, and Visa fit this style due to balance-sheet strength, recurring revenue, and pricing power.',
      examples: 'Popular investors with similar mindset: Ray Dalio (balance and risk budgeting), David Swensen-style allocation, and balanced family office investors.',
      strengths: 'You combine offense and defense effectively. Your portfolio tends to remain robust across multiple macro regimes and avoids dependence on a single market narrative.',
      weaknesses: 'Balanced structures can feel slow in strong momentum markets. Without disciplined rebalancing, portfolios can drift and lose the very balance that makes them effective.'
    },
    'mid-low': {
      emoji: 'CI',
      name: 'Core Indexer',
      desc: 'You are systematic and consistency-driven. You avoid emotional timing and generally prefer reliable frameworks over short-term prediction attempts.',
      advice: 'Center the portfolio on total-market and S&P 500 ETFs with international exposure. Automate contributions and rebalance periodically; if adding individual stocks, keep to liquid mega-cap quality leaders like Microsoft.',
      examples: 'Popular investors with similar mindset: John Bogle followers, Warren Buffett advice for most investors, and Bill Gates style of long-horizon compounding.',
      strengths: 'Your process minimizes behavioral errors, transaction friction, and fee drag. Over long horizons, this discipline often outperforms inconsistent active decision-making.',
      weaknesses: 'You may underreact to major structural changes if you become too passive. In concentration-heavy index markets, hidden risk can build unless you periodically review exposures.'
    },
    'mid-mid': {
      emoji: 'QG',
      name: 'Quality Grower',
      desc: 'You seek upside with discipline. You are attracted to growth but still filter for fundamentals, business durability, and execution quality.',
      advice: 'Concentrate on quality compounders in software and semiconductors, supported by broad ETFs. Microsoft, Nvidia, and Adobe often suit this profile because of strong margins, recurring demand, and reinvestment capacity.',
      examples: 'Popular investors with similar mindset: Peter Lynch, Philip Fisher, and Bill Gates-like focus on durable technology ecosystems.',
      strengths: 'You capture structural growth while preserving quality standards. This tends to improve long-run return quality and reduce blow-up risk from low-grade speculation.',
      weaknesses: 'Quality can still become overvalued. If valuation discipline is ignored, even excellent businesses can produce weak forward returns after crowded entry points.'
    },
    'mid-high': {
      emoji: 'TA',
      name: 'Tactical Analyzer',
      desc: 'You are data-sensitive and adaptive. You are willing to shift exposures when market structure changes, as long as rules remain clear and consistent.',
      advice: 'Maintain a long-term core, then use a tactical sleeve driven by trend and factor signals. Rotate between quality tech, defensives, and cyclicals based on regime evidence rather than narrative bias.',
      examples: 'Popular investors with similar mindset: Jim Simons systematic style, Cliff Asness factor approach, and Ray Dalio macro risk framework.',
      strengths: 'You adapt faster than static portfolios and can reduce damage in clear regime shifts. Rules-based timing can materially improve risk-adjusted outcomes when executed consistently.',
      weaknesses: 'Complexity and overfitting are your biggest threats. Too many signals can create noise, churn, and contradictory decisions that reduce net performance.'
    },
    'high-low': {
      emoji: 'VV',
      name: 'Visionary Venture',
      desc: 'You are future-oriented and conviction-led. You can tolerate meaningful volatility if the long-term opportunity has transformative potential.',
      advice: 'Build a stable base and then allocate a capped innovation sleeve. Prioritize frontier leaders in AI, advanced software, and selected biotech platforms; examples include Nvidia and Tesla with strict position limits.',
      examples: 'Popular investors with similar mindset: Cathie Wood, early-stage venture allocators, and Bill Gates style interest in long-horizon technological transformation.',
      strengths: 'You are well-positioned to capture nonlinear upside from transformative trends early. When right, your winners can dominate total portfolio returns.',
      weaknesses: 'Narrative risk and volatility drag can be severe. Without hard sizing limits and rebalancing discipline, drawdowns can become psychologically and financially destructive.'
    },
    'high-mid': {
      emoji: 'HR',
      name: 'High-Risk Rider',
      desc: 'You are aggressive, fast-moving, and comfortable with large swings. You can capture momentum quickly, but concentration risk must be tightly controlled.',
      advice: 'Use a defined speculative bucket for high-beta opportunities and keep a diversified core for stability. Liquid names such as AMD and Palantir can fit, but position limits and stop discipline are non-negotiable.',
      examples: 'Popular investors with similar mindset: George Soros-style conviction sizing (with strict risk control), aggressive momentum traders, and macro-tactical investors.',
      strengths: 'You can exploit momentum and dislocations quickly, especially in high-volatility phases where slower investors hesitate.',
      weaknesses: 'Behavioral overreach is the core threat. Overtrading, leverage creep, and emotional size escalation can erase gains rapidly if controls fail.'
    },
    'high-high': {
      emoji: 'AE',
      name: 'Alternative Explorer',
      desc: 'You are curious, contrarian, and willing to invest beyond standard stock-bond frameworks. You seek diversification through multiple return engines.',
      advice: 'Keep a liquid core, then add alternatives such as REITs, commodities, and infrastructure. In equities, combine durable leaders with real-asset exposure to reduce dependence on one market narrative.',
      examples: 'Popular investors with similar mindset: Ray Dalio (diversification across drivers), Bill Gates multi-asset orientation, and alternative-focused institutional allocators.',
      strengths: 'You reduce single-asset dependency and can improve resilience by combining uncorrelated return streams.',
      weaknesses: 'Alternative portfolios can become opaque and expensive. Without clear thesis tracking, complexity can hide risk rather than diversify it.'
    }
  };

  const info = typeLookup[combo] || { emoji: 'UN', name: 'Unknown', desc: '', advice: '', examples: '' };
  resultDiv.innerHTML = '';

  const resText = document.createElement('div');
  resText.className = 'result-type';
  resText.textContent = `${info.emoji} ${info.name}`;
  resultDiv.appendChild(resText);

  const typeTitle = document.createElement('div');
  typeTitle.className = 'result-section-title';
  typeTitle.textContent = 'What type of investor are you';
  resultDiv.appendChild(typeTitle);

  const descP = document.createElement('p');
  descP.className = 'result-copy';
  descP.textContent = info.desc || '';
  resultDiv.appendChild(descP);

  const behaviorP = document.createElement('p');
  behaviorP.className = 'result-copy';
  behaviorP.textContent =
    riskBand === 'low'
      ? 'In real market stress, your natural advantage is emotional control. You are less likely to panic-sell quality holdings, which improves long-term compounding. The most important thing for your profile is staying sufficiently invested while preserving your discipline.'
      : riskBand === 'mid'
        ? 'In volatile markets, you typically balance caution and opportunity better than most investors. Your success depends on maintaining structure: clear position sizing, rebalancing rules, and avoiding impulsive theme chasing when narratives are loud.'
        : 'During high-volatility phases, you can react quickly and capture large upside, but your outcomes depend heavily on risk control. For your profile, disciplined sizing and strict loss management are as important as selecting high-upside assets.';
  resultDiv.appendChild(behaviorP);

  const investTitle = document.createElement('div');
  investTitle.className = 'result-section-title';
  investTitle.textContent = 'What you should invest in';
  resultDiv.appendChild(investTitle);

  const advP = document.createElement('p');
  advP.className = 'result-copy';
  advP.textContent = info.advice || '';
  resultDiv.appendChild(advP);

  const implementationP = document.createElement('p');
  implementationP.className = 'result-copy';
  implementationP.textContent =
    'Implementation note: this recommendation is designed to be executable, not theoretical. The right portfolio for your type is one you can hold through both fear and euphoria without abandoning the plan. Consistency of execution is a core return driver.';
  resultDiv.appendChild(implementationP);

  const similarTitle = document.createElement('div');
  similarTitle.className = 'result-section-title';
  similarTitle.textContent = 'Popular investors with similar style';
  resultDiv.appendChild(similarTitle);

  const exP = document.createElement('p');
  exP.className = 'result-copy';
  exP.textContent = info.examples || 'No close match found yet.';
  resultDiv.appendChild(exP);

  const strengthsTitle = document.createElement('div');
  strengthsTitle.className = 'result-section-title';
  strengthsTitle.textContent = 'Core strengths';
  resultDiv.appendChild(strengthsTitle);

  const strengthsP = document.createElement('p');
  strengthsP.className = 'result-copy';
  strengthsP.textContent = info.strengths || '';
  resultDiv.appendChild(strengthsP);

  const weaknessesTitle = document.createElement('div');
  weaknessesTitle.className = 'result-section-title';
  weaknessesTitle.textContent = 'Main weaknesses to manage';
  resultDiv.appendChild(weaknessesTitle);

  const weaknessesP = document.createElement('p');
  weaknessesP.className = 'result-copy';
  weaknessesP.textContent = info.weaknesses || '';
  resultDiv.appendChild(weaknessesP);

  launchConfetti();

  const instr = document.createElement('p');
  instr.textContent = 'To receive a tailored portfolio suggestion, enter your budget and currency below, then click "Generate Portfolio". (Scroll down if necessary.)';
  instr.style.marginTop = '10px';
  resultDiv.appendChild(instr);

  const newsLink = document.createElement('p');
  newsLink.style.marginTop = '6px';
  newsLink.innerHTML = 'Recommended reading for your profile: <a href="./recommended-news.html" style="color:#93ffd8;">Open Recommended News</a>';
  resultDiv.appendChild(newsLink);

  const planning = document.getElementById('planning');
  if (planning) {
    planning.style.display = 'block';
    planning.scrollIntoView({ behavior: 'smooth' });
  }

  const planBtn = document.getElementById('plan-btn');
  if (planBtn) {
    planBtn.onclick = () => {
      const budget = parseFloat((document.getElementById('budget') || {}).value) || 0;
      const currency = (document.getElementById('currency') || {}).value || 'USD';
      const portfolio = calculatePortfolio(combo, riskBand, budget, currency);
      const out = document.getElementById('portfolio-result');
      if (!out) return;

      out.innerHTML = '';

      const addHeading = (text) => {
        const h = document.createElement('h4');
        h.className = 'portfolio-section-title';
        h.textContent = text;
        out.appendChild(h);
      };

      const addPara = (text) => {
        const p = document.createElement('p');
        p.className = 'portfolio-copy';
        p.textContent = text;
        out.appendChild(p);
      };

      addHeading(`Market Condition (${portfolio.market.date})`);
      addPara(portfolio.market.summary);

      addHeading('Recommended Allocation (Adjusted for Market Condition)');
      portfolio.allocations.forEach((a) => {
        addPara(`${a.name}: ${currency} ${a.amount} (${a.pct}%)`);
      });

      addHeading('Portfolio Rationale');
      addPara(portfolio.notes);

      addHeading('Detailed Investment Plan');
      portfolio.picks.forEach((pick) => {
        addHeading(pick.name);
        addPara(`Suggested allocation: ${currency} ${pick.amount} (${pick.pct}%)`);
        addPara(`Why this helps your style: ${pick.why}`);
      });

      addHeading('Why This Portfolio Is Meaningful');
      addPara(portfolio.conclusion);

      if (portfolio.chartData && window.Chart) {
        const chartContainer = document.createElement('div');
        chartContainer.style.marginTop = '28px';
        chartContainer.innerHTML =
          '<h4 class="portfolio-section-title">Allocation Mix</h4><canvas id="chart-allocation" width="420" height="220"></canvas>' +
          '<h4 class="portfolio-section-title" style="margin-top:18px;">Recommended Investments Breakdown</h4><canvas id="chart-investments" width="420" height="240"></canvas>';
        out.appendChild(chartContainer);

        const allocationCtx = document.getElementById('chart-allocation').getContext('2d');
        new Chart(allocationCtx, {
          type: 'doughnut',
          data: {
            labels: portfolio.chartData.allocationLabels,
            datasets: [
              {
                label: 'Allocation %',
                data: portfolio.chartData.allocationWeights,
                backgroundColor: ['rgba(46,211,191,0.88)', 'rgba(72,193,255,0.88)', 'rgba(255,209,102,0.88)'],
                borderColor: ['#7ff3df', '#a6ddff', '#ffe9ad'],
                borderWidth: 1.5,
                hoverOffset: 6
              }
            ]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { labels: { color: '#d5eef6' }, position: 'bottom' }
            },
            cutout: '58%'
          }
        });

        const investmentsCtx = document.getElementById('chart-investments').getContext('2d');
        new Chart(investmentsCtx, {
          type: 'bar',
          data: {
            labels: portfolio.chartData.investmentLabels,
            datasets: [
              {
                label: 'Recommended Weight %',
                data: portfolio.chartData.investmentWeights,
                backgroundColor: portfolio.chartData.investmentColors,
                borderRadius: 9,
                borderSkipped: false
              }
            ]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { labels: { color: '#d5eef6' } }
            },
            scales: {
              x: { ticks: { color: '#c7e4ee', maxRotation: 20, minRotation: 0 } },
              y: { beginAtZero: true, max: 40, ticks: { color: '#c7e4ee' }, grid: { color: 'rgba(180,220,232,0.14)' } }
            }
          }
        });
      }

    };
  }
}

function calculatePortfolio(combo, riskBand, budget, currency = 'USD') {
  const marketCondition = {
    date: '2026-02-19',
    stance: 'cautious',
    summary: 'Current regime: disinflation is improving, but policy uncertainty and geopolitical risk still justify quality bias and liquidity discipline.'
  };

  const profileMap = {
    'low-low': {
      allocation: { stocks: 15, bonds: 65, cash: 20 },
      picks: [
        { name: 'U.S. Treasury ETF (IEF)', pct: 30, why: 'Rate-sensitive defensive anchor and strong drawdown control.' },
        { name: 'Investment Grade Bond ETF (LQD)', pct: 25, why: 'Higher income with controlled credit risk.' },
        { name: 'Dividend ETF (SCHD)', pct: 15, why: 'Quality dividend exposure with lower volatility than pure growth baskets.' },
        { name: 'Johnson & Johnson (JNJ)', pct: 10, why: 'Defensive healthcare cash flows and resilient demand.' },
        { name: 'Procter & Gamble (PG)', pct: 10, why: 'Consumer staples pricing power in slowdowns.' },
        { name: 'Cash / Money Market', pct: 10, why: 'Liquidity for optionality and volatility buffering.' }
      ],
      notes: 'This portfolio emphasizes preservation and consistency first, then adds selective equity exposure for inflation-aware compounding.'
    },
    'low-mid': {
      allocation: { stocks: 25, bonds: 55, cash: 20 },
      picks: [
        { name: 'Core Bond ETF (BND)', pct: 28, why: 'Broad fixed-income base for stability and income.' },
        { name: 'Treasury ETF (VGIT)', pct: 22, why: 'Improves portfolio resilience when risk assets weaken.' },
        { name: 'Dividend ETF (VYM)', pct: 15, why: 'Income-focused equities with diversified exposure.' },
        { name: 'Realty Income (O)', pct: 10, why: 'Monthly dividend REIT cash flow profile.' },
        { name: 'PepsiCo (PEP)', pct: 10, why: 'Defensive consumer demand and steady payout history.' },
        { name: 'Cash / T-Bills', pct: 15, why: 'Dry powder and volatility cushion.' }
      ],
      notes: 'Income and downside defense drive this mix. Equity exposure exists, but only in names and sectors with durable payout quality.'
    },
    'low-high': {
      allocation: { stocks: 45, bonds: 40, cash: 15 },
      picks: [
        { name: 'S&P 500 ETF (VOO)', pct: 25, why: 'Low-cost broad U.S. equity base.' },
        { name: 'Microsoft (MSFT)', pct: 10, why: 'High-quality earnings and platform durability.' },
        { name: 'Apple (AAPL)', pct: 10, why: 'Strong ecosystem and free-cash-flow strength.' },
        { name: 'Core Bond ETF (BND)', pct: 25, why: 'Stabilizes total portfolio volatility.' },
        { name: 'Treasury ETF (IEF)', pct: 15, why: 'Adds protection in risk-off periods.' },
        { name: 'Cash / Money Market', pct: 15, why: 'Liquidity for rebalancing opportunities.' }
      ],
      notes: 'You get measured growth potential while keeping meaningful defensive ballast for uncertain market phases.'
    },
    'mid-low': {
      allocation: { stocks: 50, bonds: 35, cash: 15 },
      picks: [
        { name: 'Total Market ETF (VTI)', pct: 30, why: 'Simple, diversified core exposure.' },
        { name: 'International ETF (VXUS)', pct: 10, why: 'Geographic diversification and valuation balance.' },
        { name: 'Microsoft (MSFT)', pct: 10, why: 'Optional single-stock quality satellite.' },
        { name: 'Core Bond ETF (BND)', pct: 20, why: 'Portfolio smoother and income support.' },
        { name: 'Treasury ETF (VGIT)', pct: 15, why: 'Interest-rate and recession hedge component.' },
        { name: 'Cash / T-Bills', pct: 15, why: 'Behavioral and liquidity buffer.' }
      ],
      notes: 'This is a rules-driven compounding structure that minimizes complexity and behavior mistakes.'
    },
    'mid-mid': {
      allocation: { stocks: 60, bonds: 25, cash: 15 },
      picks: [
        { name: 'S&P 500 ETF (VOO)', pct: 25, why: 'Core quality-weighted U.S. market exposure.' },
        { name: 'Microsoft (MSFT)', pct: 12, why: 'Durable enterprise ecosystem and strong margins.' },
        { name: 'Nvidia (NVDA)', pct: 10, why: 'Secular AI and compute demand leadership.' },
        { name: 'Adobe (ADBE)', pct: 8, why: 'Recurring software revenue and pricing power.' },
        { name: 'Core Bond ETF (BND)', pct: 20, why: 'Reduces total portfolio volatility.' },
        { name: 'Cash / Money Market', pct: 25, why: 'Flexibility and drawdown management reserve.' }
      ],
      notes: 'You prioritize high-quality growth while keeping enough defense to stay invested through deep corrections.'
    },
    'mid-high': {
      allocation: { stocks: 65, bonds: 20, cash: 15 },
      picks: [
        { name: 'S&P 500 ETF (VOO)', pct: 22, why: 'Core anchor for long-run market participation.' },
        { name: 'Microsoft (MSFT)', pct: 10, why: 'Quality and resilience across regimes.' },
        { name: 'Apple (AAPL)', pct: 10, why: 'Cash flow depth and ecosystem stickiness.' },
        { name: 'UnitedHealth (UNH)', pct: 8, why: 'Defensive earnings profile relative to cyclicals.' },
        { name: 'Tactical / Factor ETF', pct: 15, why: 'Regime-based adaptation sleeve.' },
        { name: 'Bonds + Cash', pct: 35, why: 'Risk control capital used for tactical redeployment.' }
      ],
      notes: 'This structure allows tactical flexibility while preserving a robust long-term core.'
    },
    'high-low': {
      allocation: { stocks: 70, bonds: 15, cash: 15 },
      picks: [
        { name: 'Core ETF (VOO)', pct: 20, why: 'Keeps base diversification while pursuing upside themes.' },
        { name: 'Nvidia (NVDA)', pct: 15, why: 'AI infrastructure leader with strong demand tailwinds.' },
        { name: 'Tesla (TSLA)', pct: 12, why: 'High-beta innovation exposure with asymmetric potential.' },
        { name: 'Innovation ETF', pct: 13, why: 'Diversifies thematic growth beyond a single name.' },
        { name: 'Core Bond ETF', pct: 15, why: 'Reduces forced selling during volatility shocks.' },
        { name: 'Cash / T-Bills', pct: 25, why: 'Risk control and opportunistic deployment reserve.' }
      ],
      notes: 'You retain high-upside innovation exposure but protect outcomes through explicit diversification and liquidity.'
    },
    'high-mid': {
      allocation: { stocks: 75, bonds: 10, cash: 15 },
      picks: [
        { name: 'S&P 500 ETF (SPY)', pct: 20, why: 'Liquid base position for broad risk exposure.' },
        { name: 'AMD (AMD)', pct: 14, why: 'High-beta semiconductor growth expression.' },
        { name: 'Palantir (PLTR)', pct: 12, why: 'Data/AI optionality with momentum sensitivity.' },
        { name: 'Small-Cap Growth ETF', pct: 14, why: 'Tactical upside with diversified high-beta basket.' },
        { name: 'Short Treasury ETF', pct: 10, why: 'Fast-access defense and collateral-like stability.' },
        { name: 'Cash', pct: 30, why: 'Drawdown control and re-entry flexibility after volatility spikes.' }
      ],
      notes: 'Aggressive return potential is preserved, but downside is managed through strict cash and liquidity allocation.'
    },
    'high-high': {
      allocation: { stocks: 65, bonds: 10, cash: 25 },
      picks: [
        { name: 'Global Equity ETF', pct: 20, why: 'Diversified equity base across regions.' },
        { name: 'Microsoft (MSFT)', pct: 10, why: 'Quality anchor inside growth-heavy mix.' },
        { name: 'Nvidia (NVDA)', pct: 10, why: 'Secular growth engine and innovation beta.' },
        { name: 'REIT ETF (VNQ)', pct: 12, why: 'Real-asset diversification and income component.' },
        { name: 'Commodity ETF', pct: 8, why: 'Inflation and macro diversification driver.' },
        { name: 'Cash / Short T-Bills', pct: 40, why: 'Flexibility for alternative opportunities and risk reset capacity.' }
      ],
      notes: 'This profile uses multiple return engines while preserving a large liquidity buffer for tactical flexibility.'
    }
  };

  const selected = profileMap[combo] || profileMap['mid-mid'];
  const allocation = { ...selected.allocation };

  if (marketCondition.stance === 'cautious') {
    if (riskBand === 'low') {
      allocation.stocks -= 3;
      allocation.bonds += 2;
      allocation.cash += 1;
    } else if (riskBand === 'mid') {
      allocation.stocks -= 5;
      allocation.bonds += 3;
      allocation.cash += 2;
    } else {
      allocation.stocks -= 6;
      allocation.bonds += 2;
      allocation.cash += 4;
    }
  }

  const allocations = [
    { name: 'Stocks', pct: allocation.stocks },
    { name: 'Bonds', pct: allocation.bonds },
    { name: 'Cash', pct: allocation.cash }
  ];

  const computedAllocations = allocations.map((a) => ({
    ...a,
    amount: Math.round((budget * a.pct) / 100)
  }));

  const computedPicks = selected.picks.map((pick) => ({
    ...pick,
    amount: Math.round((budget * pick.pct) / 100)
  }));

  const chartData = {
    allocationLabels: allocations.map((a) => a.name),
    allocationWeights: allocations.map((a) => a.pct),
    investmentLabels: computedPicks.map((p) => p.name),
    investmentWeights: computedPicks.map((p) => p.pct),
    investmentColors: [
      'rgba(46,211,191,0.85)',
      'rgba(72,193,255,0.85)',
      'rgba(255,209,102,0.85)',
      'rgba(247,140,107,0.85)',
      'rgba(183,148,244,0.85)',
      'rgba(125,211,252,0.85)'
    ]
  };

  return {
    market: marketCondition,
    allocations: computedAllocations,
    notes: selected.notes,
    picks: computedPicks,
    conclusion: 'This recommendation blends your behavioral profile with the current macro regime. The goal is to give you a portfolio you can realistically hold through uncertainty, so performance comes from disciplined execution rather than reactive decisions.',
    chartData
  };
}

function launchConfetti() {
  const symbols = ['*', '+', '$', '%', '@'];
  for (let i = 0; i < 20; i += 1) {
    const span = document.createElement('span');
    span.className = 'confetti';
    span.textContent = symbols[Math.floor(Math.random() * symbols.length)];
    span.style.left = Math.random() * 100 + '%';
    document.body.appendChild(span);
    span.addEventListener('animationend', () => span.remove());
  }
}
